{
  "_id": "_design/geo",
  "_rev": "3-1f146b874f028fa9354665a790e83c25",
  "views": {
    "tile": {
      "map": "function (doc) {\n  var tile_size = 256;\n  var pixels = 4;\n\n  if (doc._id.match(/^geotagged/)) {\n    for (var page in doc.annotations) {\n      for (var line in doc.annotations[page]) {\n        for (var i in doc.annotations[page][line]) {\n          if (doc.annotations[page][line][i].geojson) {\n            var feature = doc.annotations[page][line][i].geojson;\n            for (var zoom = 0; zoom < 11; zoom++) {\n              var x_pos = (parseFloat(feature.geometry.coordinates[0]) + 180)/360 * Math.pow(2, zoom);\n              var x = Math.floor(x_pos);\n    \n              var relative_x = Math.round(tile_size * (x_pos - x));\n  \n              var y_pos = (1-Math.log(Math.tan(parseFloat (feature.geometry.coordinates[1])*Math.PI/180) + 1/Math.cos(parseFloat(feature.geometry.coordinates[1])*Math.PI/180))/Math.PI)/2 *Math.pow(2,zoom);\n              var y = Math.floor(y_pos);\n              var relative_y = Math.round(tile_size * (y_pos - y));\n  \n              relative_x = Math.floor(relative_x / pixels) * pixels;\n              relative_y = Math.floor(relative_y / pixels) * pixels;\n  \n              var tile = [];\n              tile.push(zoom);\n              tile.push(x);\n              tile.push(y);\n              tile.push(relative_x);\n              tile.push(relative_y);\n     \n              emit(tile, 1);\n            }\n          }\n        }\n      }\n    }\n  }\n}",
      "reduce": "_sum"
    }
  },
  "language": "javascript"
}